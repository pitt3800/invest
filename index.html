<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>응급의학과 전문의 종합 자산관리 대시보드</title>
    <!-- Favicon 오류 완전 차단 -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%23667eea'/%3E%3Cpath d='M16 8c0-.553-.447-1-1-1h-2c-.553 0-1 .447-1 1v4H8c-.553 0-1 .447-1 1v2c0 .553.447 1 1 1h4v4c0 .553.447 1 1 1h2c.553 0 1-.447 1-1v-4h4c.553 0 1-.447 1-1v-2c0-.553-.447-1-1-1h-4V8z' fill='white'/%3E%3Ccircle cx='24' cy='24' r='3' fill='%2328a745'/%3E%3C/svg%3E">
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
    <style>
        /*
        ===========================================
        통합 대시보드 기본 스타일
        ===========================================
        */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* 헤더 영역 */
        .dashboard-header {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .dashboard-title {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .dashboard-subtitle {
            color: #666;
            font-size: 1.2em;
        }
        
        .last-update {
            color: #999;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        /* 동기화 상태 표시 */
        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 200px;
        }
        
        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        
        .sync-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
        }
        
        .sync-dot.connected {
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* 요약 정보 섹션 */
        .summary-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        
        .summary-card.income::before {
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        }
        
        .summary-card.expense::before {
            background: linear-gradient(90deg, #dc3545 0%, #fd7e14 100%);
        }
        
        .summary-card.investment::before {
            background: linear-gradient(90deg, #007bff 0%, #17a2b8 100%);
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .summary-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            margin-bottom: 15px;
        }
        
        .summary-icon.assets {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }
        
        .summary-icon.income {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }
        
        .summary-icon.expense {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }
        
        .summary-icon.investment {
            background: rgba(0, 123, 255, 0.1);
            color: #007bff;
        }
        
        .summary-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .summary-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .summary-detail {
            font-size: 0.85em;
            color: #999;
        }
        
        /* 모듈 탭 네비게이션 */
        .module-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        
        .module-tab {
            flex: 1;
            padding: 15px 25px;
            background: #f8f9fa;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .module-tab.active {
            background: #667eea;
            color: white;
            transform: scale(1.02);
        }
        
        .module-tab:hover:not(.active) {
            background: #e9ecef;
            color: #333;
        }
        
        /* 모듈 컨테이너 */
        .module-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            min-height: 600px;
        }
        
        .module-frame {
            width: 100%;
            height: 800px;
            border: none;
            display: none;
        }
        
        .module-frame.active {
            display: block;
        }
        
        /* 로딩 상태 */
        .loading-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            display: none;
        }
        
        .loading-state.active {
            display: block;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 상태 메시지 */
        .status-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            background: #28a745;
            color: white;
            font-weight: 500;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .status-message.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .status-message.error {
            background: #dc3545;
        }
        
        .status-message.info {
            background: #17a2b8;
        }
        
        /* 퀵 액션 버튼들 */
        .quick-actions {
            position: fixed;
            bottom: 100px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .quick-action-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .quick-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .quick-action-btn.refresh {
            background: #28a745;
        }
        
        .quick-action-btn.settings {
            background: #6c757d;
        }
        
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .dashboard-title {
                font-size: 1.8em;
            }
            
            .summary-section {
                grid-template-columns: 1fr;
            }
            
            .module-tabs {
                flex-direction: column;
            }
            
            .module-frame {
                height: 600px;
            }
            
            .quick-actions {
                bottom: 20px;
                right: 20px;
            }
            
            .sync-status {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- 동기화 상태 표시 -->
        <div class="sync-status">
            <div class="sync-indicator">
                <div class="sync-dot" id="module1SyncDot"></div>
                <span id="module1SyncStatus">모듈1: 연결 중...</span>
            </div>
            <div class="sync-indicator">
                <div class="sync-dot" id="module2SyncDot"></div>
                <span id="module2SyncStatus">모듈2: 연결 중...</span>
            </div>
            <div style="font-size: 0.8em; color: #666; margin-top: 10px;">
                마지막 동기화: <span id="lastSyncTime">-</span>
            </div>
        </div>
        
        <!-- 대시보드 헤더 -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">
                <span>🏥</span>
                <span>응급의학과 전문의 종합 자산관리 대시보드</span>
            </h1>
            <p class="dashboard-subtitle">자산 현황, 수입/지출, 투자여력을 한눈에 관리하세요</p>
            <div class="last-update">마지막 업데이트: <span id="lastUpdateTime">-</span></div>
        </div>
        
        <!-- 요약 정보 섹션 -->
        <div class="summary-section">
            <!-- 총 자산 카드 -->
            <div class="summary-card">
                <div class="summary-icon assets">💰</div>
                <div class="summary-label">총 자산</div>
                <div class="summary-value" id="totalAssetsValue">-</div>
                <div class="summary-detail" id="totalAssetsDetail">자산 0개 등록</div>
            </div>
            
            <!-- 월 수입 카드 -->
            <div class="summary-card income">
                <div class="summary-icon income">💵</div>
                <div class="summary-label">월 총수입</div>
                <div class="summary-value" id="monthlyIncomeValue">-</div>
                <div class="summary-detail" id="monthlyIncomeDetail">수입 0건</div>
            </div>
            
            <!-- 월 지출 카드 -->
            <div class="summary-card expense">
                <div class="summary-icon expense">💳</div>
                <div class="summary-label">월 총지출</div>
                <div class="summary-value" id="monthlyExpenseValue">-</div>
                <div class="summary-detail" id="monthlyExpenseDetail">지출 0건</div>
            </div>
            
            <!-- 투자여력 카드 -->
            <div class="summary-card investment">
                <div class="summary-icon investment">📈</div>
                <div class="summary-label">월 투자여력</div>
                <div class="summary-value" id="investmentCapacityValue">-</div>
                <div class="summary-detail" id="investmentCapacityDetail">수입 - 지출</div>
            </div>
        </div>
        
        <!-- 모듈 탭 네비게이션 -->
        <div class="module-tabs">
            <button class="module-tab active" onclick="모듈전환('module1')">
                <span>📊</span>
                <span>자산 현황 관리</span>
            </button>
            <button class="module-tab" onclick="모듈전환('module2')">
                <span>💰</span>
                <span>수입/지출 관리</span>
            </button>
        </div>
        
        <!-- 모듈 컨테이너 -->
        <div class="module-container">
            <!-- 로딩 상태 -->
            <div class="loading-state active" id="loadingState">
                <div class="loading-spinner"></div>
                <p>모듈을 불러오는 중...</p>
            </div>
            
            <!-- 모듈 1: 자산 현황 -->
            <iframe id="module1" class="module-frame active" src="assets.html"></iframe>
            
            <!-- 모듈 2: 수입/지출 -->
            <iframe id="module2" class="module-frame" src="income_expense.html"></iframe>
        </div>
    </div>
    
    <!-- 퀵 액션 버튼들 -->
    <div class="quick-actions">
        <button class="quick-action-btn refresh" onclick="전체데이터새로고침()" title="데이터 새로고침">
            🔄
        </button>
        <button class="quick-action-btn settings" onclick="디버그모드토글()" title="디버그 모드">
            🔧
        </button>
    </div>
    
    <!-- 상태 메시지 -->
    <div class="status-message" id="statusMessage"></div>
    
    <script>
        /*
        ===========================================
        ⭐ 개선된 통합 대시보드 메인 스크립트 ⭐
        ===========================================
        */
        
        // 전역 변수
        let 현재모듈 = 'module1';
        let 모듈1연결상태 = false;
        let 모듈2연결상태 = false;
        let 모듈1데이터 = null;
        let 모듈2데이터 = null;
        let 디버그모드 = false;
        
        // ⭐ 수정된 localStorage 키 이름 (모듈과 정확히 일치)
        const STORAGE_KEYS = {
            모듈1: 'module1_asset_data',
            모듈2: 'module2_monthly_data'
        };
        
        // 디버깅용 로그 함수
        function 로그(메시지, 데이터 = null) {
            const 시간 = new Date().toLocaleTimeString();
            const 로그메시지 = `[${시간}] 🔍 대시보드: ${메시지}`;
            
            if (디버그모드) {
                console.log(로그메시지);
                if (데이터) {
                    console.log('📊 데이터:', 데이터);
                }
            }
        }
        
        // 디버그 모드 토글
        function 디버그모드토글() {
            디버그모드 = !디버그모드;
            상태메시지표시(`디버그 모드 ${디버그모드 ? '활성화' : '비활성화'}`, 'info');
            로그(`디버그 모드 ${디버그모드 ? 'ON' : 'OFF'}`);
            
            if (디버그모드) {
                // 디버그 정보 표시
                setTimeout(() => {
                    로그('=== 디버그 정보 ===');
                    로그('모듈1 연결상태', 모듈1연결상태);
                    로그('모듈2 연결상태', 모듈2연결상태);
                    로그('모듈1 데이터', 모듈1데이터);
                    로그('모듈2 데이터', 모듈2데이터);
                    로그('localStorage 키들', Object.keys(localStorage));
                }, 100);
            }
        }
        
        /*
        ===========================================
        ⭐ 완전히 새로운 모듈 통신 및 데이터 관리 ⭐
        ===========================================
        */
        
        // ⭐ 강화된 localStorage 변경 감지
        let 저장소감지타이머 = null;
        function 저장소변경감지시작() {
            // 기존 타이머 정리
            if (저장소감지타이머) {
                clearInterval(저장소감지타이머);
            }
            
            // 1초마다 localStorage 확인
            저장소감지타이머 = setInterval(() => {
                const 현재시점 = new Date().getTime();
                
                // 모듈1 데이터 확인
                try {
                    const 모듈1저장데이터 = localStorage.getItem(STORAGE_KEYS.모듈1);
                    if (모듈1저장데이터) {
                        const 파싱데이터 = JSON.parse(모듈1저장데이터);
                        const 마지막업데이트 = new Date(파싱데이터.마지막업데이트 || 0).getTime();
                        
                        // 최근 5초 내 업데이트된 데이터만 처리
                        if (현재시점 - 마지막업데이트 < 5000) {
                            if (!모듈1데이터 || 모듈1데이터.마지막업데이트 !== 파싱데이터.마지막업데이트) {
                                로그('🔄 모듈1 데이터 자동 감지 및 동기화');
                                모듈1데이터읽기();
                            }
                        }
                    }
                } catch (error) {
                    로그('❌ 모듈1 저장소 감지 오류', error);
                }
                
                // ⭐ 모듈2 데이터 확인 (개선)
                try {
                    const 모듈2저장데이터 = localStorage.getItem(STORAGE_KEYS.모듈2);
                    if (모듈2저장데이터) {
                        const 파싱데이터 = JSON.parse(모듈2저장데이터);
                        const 마지막업데이트 = new Date(파싱데이터.마지막업데이트 || 0).getTime();
                        
                        // 최근 5초 내 업데이트된 데이터만 처리
                        if (현재시점 - 마지막업데이트 < 5000) {
                            if (!모듈2데이터 || 모듈2데이터.마지막업데이트 !== 파싱데이터.마지막업데이트) {
                                로그('🔄 모듈2 데이터 자동 감지 및 동기화');
                                모듈2데이터읽기();
                            }
                        }
                    }
                } catch (error) {
                    로그('❌ 모듈2 저장소 감지 오류', error);
                }
            }, 1000);
            
            로그('✅ 저장소 변경 감지 시작됨');
        }
        
        // ⭐ 개선된 모듈1 데이터 읽기
        function 모듈1데이터읽기() {
            try {
                const 저장된데이터 = localStorage.getItem(STORAGE_KEYS.모듈1);
                if (저장된데이터) {
                    const 데이터 = JSON.parse(저장된데이터);
                    로그('📊 모듈1 데이터 읽기 성공', 데이터);
                    
                    // ⭐ 안전한 데이터 구조 추출
                    const 안전한유형별합계 = 데이터.유형별합계 || {};
                    const 안전한현재자산 = 데이터.현재자산 || {};
                    const 안전한계좌별합계 = 데이터.계좌별합계 || {};
                    
                    // 총자산 계산 (안전하게)
                    let 총자산 = 0;
                    try {
                        총자산 = Object.values(안전한유형별합계).reduce((sum, val) => {
                            const 숫자값 = parseFloat(val) || 0;
                            return sum + 숫자값;
                        }, 0);
                    } catch (error) {
                        로그('⚠️ 총자산 계산 오류', error);
                        총자산 = 0;
                    }
                    
                    모듈1데이터 = {
                        총자산: 총자산,
                        자산개수: Object.keys(안전한현재자산).length,
                        현재자산: 안전한현재자산,
                        유형별합계: 안전한유형별합계,
                        계좌별합계: 안전한계좌별합계,
                        마지막업데이트: 데이터.마지막업데이트 || new Date().toISOString()
                    };
                    
                    // 연결 상태 업데이트
                    모듈1연결상태 = true;
                    동기화상태업데이트();
                    
                    모듈1데이터업데이트();
                    로그('✅ 모듈1 데이터 처리 완료', 모듈1데이터);
                    return true;
                } else {
                    로그('⚠️ 모듈1 저장된 데이터 없음');
                    모듈1연결상태 = false;
                    동기화상태업데이트();
                    return false;
                }
            } catch (error) {
                로그('❌ 모듈1 데이터 읽기 실패', error);
                모듈1연결상태 = false;
                동기화상태업데이트();
                return false;
            }
        }
        
        // ⭐ 완전히 새로운 모듈2 데이터 읽기 함수
        function 모듈2데이터읽기() {
            try {
                로그('📂 모듈2 데이터 읽기 시작');
                
                const 저장된데이터 = localStorage.getItem(STORAGE_KEYS.모듈2);
                if (저장된데이터) {
                    const 데이터 = JSON.parse(저장된데이터);
                    로그('💰 모듈2 저장된 데이터 발견', 데이터);
                    
                    // ⭐ 개선된 데이터 구조 처리
                    const 안전한월별데이터 = 데이터.월별데이터 || {};
                    
                    // 현재 월 계산
                    let 현재년월 = new Date();
                    if (데이터.현재년월) {
                        현재년월 = new Date(데이터.현재년월.year, 데이터.현재년월.month);
                    }
                    const 현재월키 = `${현재년월.getFullYear()}-${String(현재년월.getMonth() + 1).padStart(2, '0')}`;
                    
                    로그('📅 현재 월 키', 현재월키);
                    
                    // ⭐ 안전한 계산 (여러 방법으로 시도)
                    let 월수입 = 0;
                    let 월지출 = 0;
                    let 수입건수 = 0;
                    let 지출건수 = 0;
                    
                    // 방법 1: 저장된 요약 데이터 사용
                    if (데이터.월수입 !== undefined && 데이터.월지출 !== undefined) {
                        로그('💰 저장된 요약 데이터 사용');
                        월수입 = 데이터.월수입 || 0;
                        월지출 = 데이터.월지출 || 0;
                        수입건수 = 데이터.수입건수 || 0;
                        지출건수 = 데이터.지출건수 || 0;
                    } else {
                        로그('💰 월별 데이터에서 직접 계산');
                        // 방법 2: 현재 월 데이터에서 직접 계산
                        const 현재월데이터 = 안전한월별데이터[현재월키];
                        if (현재월데이터) {
                            const 수입배열 = Array.isArray(현재월데이터.수입) ? 현재월데이터.수입 : [];
                            const 지출배열 = Array.isArray(현재월데이터.지출) ? 현재월데이터.지출 : [];
                            
                            월수입 = 수입배열.reduce((sum, item) => sum + (parseFloat(item.금액) || 0), 0);
                            월지출 = 지출배열.reduce((sum, item) => sum + (parseFloat(item.금액) || 0), 0);
                            수입건수 = 수입배열.length;
                            지출건수 = 지출배열.length;
                        }
                    }
                    
                    const 투자여력 = 월수입 - 월지출;
                    
                    로그('💰 계산된 값들', { 월수입, 월지출, 투자여력, 수입건수, 지출건수 });
                    
                    모듈2데이터 = {
                        월별데이터: 안전한월별데이터,
                        월수입: 월수입,
                        월지출: 월지출,
                        투자여력: 투자여력,
                        수입건수: 수입건수,
                        지출건수: 지출건수,
                        현재년월: 데이터.현재년월 || { year: 현재년월.getFullYear(), month: 현재년월.getMonth() },
                        마지막업데이트: 데이터.마지막업데이트 || new Date().toISOString()
                    };
                    
                    // 연결 상태 업데이트
                    모듈2연결상태 = true;
                    동기화상태업데이트();
                    
                    모듈2데이터업데이트();
                    로그('✅ 모듈2 데이터 처리 완료', 모듈2데이터);
                    return true;
                } else {
                    로그('⚠️ 모듈2 저장된 데이터 없음');
                    모듈2연결상태 = false;
                    동기화상태업데이트();
                    return false;
                }
            } catch (error) {
                로그('❌ 모듈2 데이터 읽기 실패', error);
                console.error('모듈2 데이터 읽기 실패 상세:', error);
                모듈2연결상태 = false;
                동기화상태업데이트();
                return false;
            }
        }
        
        // ⭐ 동기화 상태 UI 업데이트
        function 동기화상태업데이트() {
            // 모듈1 상태
            const 모듈1점 = document.getElementById('module1SyncDot');
            const 모듈1상태 = document.getElementById('module1SyncStatus');
            
            if (모듈1연결상태) {
                모듈1점.classList.add('connected');
                모듈1상태.textContent = `모듈1: 연결됨 (${모듈1데이터?.자산개수 || 0}개 자산)`;
            } else {
                모듈1점.classList.remove('connected');
                모듈1상태.textContent = '모듈1: 연결 대기중...';
            }
            
            // ⭐ 모듈2 상태 (개선)
            const 모듈2점 = document.getElementById('module2SyncDot');
            const 모듈2상태 = document.getElementById('module2SyncStatus');
            
            if (모듈2연결상태) {
                모듈2점.classList.add('connected');
                const 투자여력 = 모듈2데이터?.투자여력 || 0;
                모듈2상태.textContent = `모듈2: 연결됨 (투자여력 ${투자여력}만원)`;
            } else {
                모듈2점.classList.remove('connected');
                모듈2상태.textContent = '모듈2: 연결 대기중...';
            }
            
            // 마지막 동기화 시간
            document.getElementById('lastSyncTime').textContent = new Date().toLocaleTimeString();
        }
        
        // ⭐ 완전한 PostMessage 이벤트 리스너
        window.addEventListener('message', function(event) {
            // 보안: 같은 origin에서만 메시지 수신
            if (event.origin !== window.location.origin && event.origin !== 'null') {
                로그('🚫 잘못된 origin에서 메시지 수신 차단:', event.origin);
                return;
            }
            
            로그('📬 메시지 수신:', event.data);
            
            try {
                const messageData = event.data;
                const messageType = messageData?.type;
                
                if (!messageType) {
                    로그('⚠️ 메시지 타입이 없음');
                    return;
                }
                
                // ========================================
                // 🔥 모듈 로드 완료 신호 처리
                // ========================================
                if (messageType === 'MODULE1_LOADED') {
                    로그('✅ 모듈1 로드 완료 신호 수신');
                    모듈1연결상태 = true;
                    동기화상태업데이트();
                    
                    // 로드 완료 후 즉시 데이터 읽기 시도
                    setTimeout(() => {
                        모듈1데이터읽기();
                        // 모듈에게 데이터 요청
                        const module1Frame = document.getElementById('module1');
                        if (module1Frame && module1Frame.contentWindow) {
                            module1Frame.contentWindow.postMessage({
                                type: 'REQUEST_DATA'
                            }, '*');
                        }
                    }, 500);
                }
                
                // ⭐ 모듈2 로드 완료 처리 강화
                if (messageType === 'MODULE2_LOADED') {
                    로그('✅ 모듈2 로드 완료 신호 수신');
                    모듈2연결상태 = true;
                    동기화상태업데이트();
                    
                    // 로드 완료 후 즉시 데이터 읽기 시도
                    setTimeout(() => {
                        모듈2데이터읽기();
                        // 모듈에게 데이터 요청
                        const module2Frame = document.getElementById('module2');
                        if (module2Frame && module2Frame.contentWindow) {
                            module2Frame.contentWindow.postMessage({
                                type: 'REQUEST_DATA'
                            }, '*');
                        }
                    }, 500);
                }
                
                // ========================================
                // ⭐ 데이터 저장 완료 신호 처리 (강화)
                // ========================================
                if (messageType === 'DATA_SAVED') {
                    로그('💾 모듈에서 데이터 저장 완료 신호 수신');
                    const moduleName = messageData.module;
                    
                    // 저장 완료 후 즉시 데이터 동기화
                    setTimeout(() => {
                        if (moduleName === 'module1') {
                            모듈1데이터읽기();
                        } else if (moduleName === 'module2') {
                            로그('💾 모듈2 저장 완료 - 데이터 읽기 시작');
                            모듈2데이터읽기();
                        }
                        상태메시지표시(`${moduleName} 데이터가 저장되었습니다`, 'success');
                    }, 200);
                }
                
                // ⭐ 즉시 데이터 저장 신호 처리 (새로 추가)
                if (messageType === 'DATA_SAVED_IMMEDIATE') {
                    로그('⚡ 모듈에서 즉시 저장 신호 수신');
                    const moduleName = messageData.module;
                    
                    // 즉시 데이터 동기화
                    if (moduleName === 'module1') {
                        모듈1데이터읽기();
                    } else if (moduleName === 'module2') {
                        로그('⚡ 모듈2 즉시 저장 - 데이터 읽기 시작');
                        모듈2데이터읽기();
                    }
                }
                
                // ========================================
                // ⭐ 데이터 업데이트 신호 처리 (강화)
                // ========================================
                if (messageType === 'MODULE1_DATA_UPDATE' || messageType === 'MODULE1_DATA') {
                    로그('📊 모듈1 데이터 업데이트 신호 수신');
                    
                    // 메시지에 데이터가 포함되어 있으면 직접 사용
                    if (messageData.data) {
                        로그('📊 모듈1 데이터를 메시지에서 직접 수신');
                        모듈1데이터처리(messageData.data);
                    } else {
                        // 데이터가 없으면 localStorage에서 읽기
                        setTimeout(() => 모듈1데이터읽기(), 100);
                    }
                }
                
                // ⭐ 모듈2 데이터 업데이트 신호 처리 (완전히 새로 작성)
                if (messageType === 'MODULE2_DATA_UPDATE' || messageType === 'MODULE2_DATA') {
                    로그('💰 모듈2 데이터 업데이트 신호 수신');
                    
                    // 메시지에 데이터가 포함되어 있으면 직접 사용
                    if (messageData.data) {
                        로그('💰 모듈2 데이터를 메시지에서 직접 수신');
                        모듈2데이터처리(messageData.data);
                    } else {
                        // 데이터가 없으면 localStorage에서 읽기
                        setTimeout(() => 모듈2데이터읽기(), 100);
                    }
                }
                
                // ========================================
                // 🔥 하트비트 신호 처리 (연결 상태 확인)
                // ========================================
                if (messageType === 'HEARTBEAT') {
                    const moduleName = messageData.module;
                    로그(`💓 ${moduleName} 하트비트 수신`);
                    
                    if (moduleName === 'module1') {
                        모듈1연결상태 = true;
                    } else if (moduleName === 'module2') {
                        모듈2연결상태 = true;
                    }
                    동기화상태업데이트();
                }
                
                // ========================================
                // 🔥 모듈 가시성 변경 신호 처리
                // ========================================
                if (messageType === 'MODULE_VISIBLE') {
                    const moduleName = messageData.module;
                    로그(`👁️ ${moduleName} 가시성 변경 신호`);
                    
                    // 모듈이 다시 보일 때 데이터 동기화
                    setTimeout(() => {
                        if (moduleName === 'module1') {
                            모듈1데이터읽기();
                        } else if (moduleName === 'module2') {
                            모듈2데이터읽기();
                        }
                    }, 300);
                }
                
                // ========================================
                // 🔥 새로고침 완료 신호 처리
                // ========================================
                if (messageType === 'REFRESH_COMPLETED') {
                    const moduleName = messageData.module;
                    로그(`🔄 ${moduleName} 새로고침 완료`);
                    
                    // 새로고침 완료 후 데이터 읽기
                    setTimeout(() => {
                        if (moduleName === 'module1') {
                            모듈1데이터읽기();
                        } else if (moduleName === 'module2') {
                            모듈2데이터읽기();
                        }
                    }, 200);
                }
                
                // ========================================
                // 🔥 기타 신호 처리
                // ========================================
                
                // 모듈에서 직접 데이터 전송 (백업 방법)
                if (messageType.startsWith('MODULE1_') && messageData.data) {
                    로그('📊 모듈1 직접 데이터 전송');
                    모듈1데이터처리(messageData.data);
                }
                
                if (messageType.startsWith('MODULE2_') && messageData.data) {
                    로그('💰 모듈2 직접 데이터 전송');
                    모듈2데이터처리(messageData.data);
                }
                
            } catch (error) {
                로그('❌ 메시지 처리 중 오류:', error);
            }
        });
        
        // ========================================
        // ⭐ 직접 데이터 처리 함수들 (새로 추가)
        // ========================================
        
        // 모듈1 데이터 직접 처리
        function 모듈1데이터처리(데이터) {
            try {
                로그('📊 모듈1 데이터 직접 처리 시작', 데이터);
                
                // 안전한 데이터 구조 추출
                const 안전한유형별합계 = 데이터.유형별합계 || {};
                const 안전한현재자산 = 데이터.현재자산 || {};
                const 안전한계좌별합계 = 데이터.계좌별합계 || {};
                
                // 총자산 계산
                let 총자산 = 0;
                try {
                    총자산 = Object.values(안전한유형별합계).reduce((sum, val) => {
                        const 숫자값 = parseFloat(val) || 0;
                        return sum + 숫자값;
                    }, 0);
                } catch (error) {
                    로그('⚠️ 총자산 계산 오류', error);
                    총자산 = 데이터.총자산 || 0;
                }
                
                모듈1데이터 = {
                    총자산: 총자산,
                    자산개수: Object.keys(안전한현재자산).length,
                    현재자산: 안전한현재자산,
                    유형별합계: 안전한유형별합계,
                    계좌별합계: 안전한계좌별합계,
                    마지막업데이트: 데이터.마지막업데이트 || new Date().toISOString()
                };
                
                // 연결 상태 업데이트
                모듈1연결상태 = true;
                동기화상태업데이트();
                
                // UI 업데이트
                모듈1데이터업데이트();
                로그('✅ 모듈1 데이터 직접 처리 완료');
                
            } catch (error) {
                로그('❌ 모듈1 데이터 직접 처리 실패:', error);
            }
        }
        
        // ⭐ 모듈2 데이터 직접 처리 (완전히 새로 작성)
        function 모듈2데이터처리(데이터) {
            try {
                로그('💰 모듈2 데이터 직접 처리 시작', 데이터);
                
                // ⭐ 안전한 데이터 추출
                const 안전한월별데이터 = 데이터.월별데이터 || {};
                
                // 현재 월 계산
                let 현재년월 = new Date();
                if (데이터.현재년월) {
                    현재년월 = new Date(데이터.현재년월.year, 데이터.현재년월.month);
                }
                const 현재월키 = `${현재년월.getFullYear()}-${String(현재년월.getMonth() + 1).padStart(2, '0')}`;
                
                // ⭐ 안전한 계산 (여러 방법 시도)
                let 월수입 = 데이터.월수입 || 0;
                let 월지출 = 데이터.월지출 || 0;
                let 수입건수 = 데이터.수입건수 || 0;
                let 지출건수 = 데이터.지출건수 || 0;
                
                // 직접 전달된 데이터가 없으면 계산
                if (월수입 === 0 && 월지출 === 0) {
                    const 현재월데이터 = 안전한월별데이터[현재월키];
                    if (현재월데이터) {
                        try {
                            const 수입배열 = Array.isArray(현재월데이터.수입) ? 현재월데이터.수입 : [];
                            const 지출배열 = Array.isArray(현재월데이터.지출) ? 현재월데이터.지출 : [];
                            
                            월수입 = 수입배열.reduce((sum, item) => sum + (parseFloat(item.금액) || 0), 0);
                            월지출 = 지출배열.reduce((sum, item) => sum + (parseFloat(item.금액) || 0), 0);
                            수입건수 = 수입배열.length;
                            지출건수 = 지출배열.length;
                        } catch (error) {
                            로그('⚠️ 모듈2 금액 계산 오류', error);
                        }
                    }
                }
                
                const 투자여력 = 월수입 - 월지출;
                
                로그('💰 모듈2 계산된 값들', { 월수입, 월지출, 투자여력, 수입건수, 지출건수 });
                
                모듈2데이터 = {
                    월별데이터: 안전한월별데이터,
                    월수입: 월수입,
                    월지출: 월지출,
                    투자여력: 투자여력,
                    수입건수: 수입건수,
                    지출건수: 지출건수,
                    현재년월: 데이터.현재년월 || { year: 현재년월.getFullYear(), month: 현재년월.getMonth() },
                    마지막업데이트: 데이터.마지막업데이트 || new Date().toISOString()
                };
                
                // 연결 상태 업데이트
                모듈2연결상태 = true;
                동기화상태업데이트();
                
                // UI 업데이트
                모듈2데이터업데이트();
                로그('✅ 모듈2 데이터 직접 처리 완료');
                
            } catch (error) {
                로그('❌ 모듈2 데이터 직접 처리 실패:', error);
                console.error('모듈2 데이터 직접 처리 실패 상세:', error);
            }
        }
        
        // ========================================
        // 🔥 모듈에게 데이터 요청하는 함수들 (새로 추가)
        // ========================================
        
        // 모듈1에게 데이터 요청
        function 모듈1데이터요청() {
            try {
                const module1Frame = document.getElementById('module1');
                if (module1Frame && module1Frame.contentWindow) {
                    module1Frame.contentWindow.postMessage({
                        type: 'REQUEST_DATA',
                        timestamp: new Date().getTime()
                    }, '*');
                    로그('📊 모듈1에게 데이터 요청 전송');
                } else {
                    로그('⚠️ 모듈1 iframe에 접근 불가');
                }
            } catch (error) {
                로그('❌ 모듈1 데이터 요청 실패:', error);
            }
        }
        
        // ⭐ 모듈2에게 데이터 요청
        function 모듈2데이터요청() {
            try {
                const module2Frame = document.getElementById('module2');
                if (module2Frame && module2Frame.contentWindow) {
                    module2Frame.contentWindow.postMessage({
                        type: 'REQUEST_DATA',
                        timestamp: new Date().getTime()
                    }, '*');
                    로그('💰 모듈2에게 데이터 요청 전송');
                } else {
                    로그('⚠️ 모듈2 iframe에 접근 불가');
                }
            } catch (error) {
                로그('❌ 모듈2 데이터 요청 실패:', error);
            }
        }
        
        // 모든 모듈에게 데이터 요청
        function 모든모듈데이터요청() {
            로그('🔄 모든 모듈에게 데이터 요청');
            모듈1데이터요청();
            모듈2데이터요청();
        }
        
        /*
        ===========================================
        ⭐ 개선된 데이터 업데이트 함수들 ⭐
        ===========================================
        */
        
        // 숫자 포맷팅
        function 숫자포맷(숫자) {
            if (typeof 숫자 !== 'number' || isNaN(숫자)) {
                return '0';
            }
            return 숫자.toLocaleString();
        }
        
        // 만원을 억원으로 변환
        function 만원을억원으로(만원) {
            if (typeof 만원 !== 'number' || isNaN(만원)) {
                return 0;
            }
            return 만원 / 10000;
        }
        
        // ⭐ 안전한 모듈1 데이터 업데이트
        function 모듈1데이터업데이트() {
            if (!모듈1데이터) {
                로그('⚠️ 모듈1 데이터가 없어 업데이트 건너뜀');
                return;
            }
            
            try {
                const 총자산만원 = 모듈1데이터.총자산 || 0;
                const 총자산억원 = 만원을억원으로(총자산만원);
                const 자산개수 = 모듈1데이터.자산개수 || 0;
                
                // 총 자산 업데이트
                document.getElementById('totalAssetsValue').textContent = 
                    `${총자산억원.toFixed(1)}억원`;
                document.getElementById('totalAssetsDetail').textContent = 
                    `자산 ${자산개수}개 등록 (${숫자포맷(총자산만원)}만원)`;
                
                업데이트시간갱신();
                상태메시지표시('자산 데이터가 업데이트되었습니다', 'success');
                로그('✅ 모듈1 UI 업데이트 완료');
                
            } catch (error) {
                로그('❌ 모듈1 UI 업데이트 오류', error);
            }
        }
        
        // ⭐ 안전한 모듈2 데이터 업데이트 (완전히 새로 작성)
        function 모듈2데이터업데이트() {
            if (!모듈2데이터) {
                로그('⚠️ 모듈2 데이터가 없어 업데이트 건너뜀');
                return;
            }
            
            try {
                const 월수입 = 모듈2데이터.월수입 || 0;
                const 월지출 = 모듈2데이터.월지출 || 0;
                const 투자여력 = 모듈2데이터.투자여력 || (월수입 - 월지출);
                const 수입건수 = 모듈2데이터.수입건수 || 0;
                const 지출건수 = 모듈2데이터.지출건수 || 0;
                
                로그('💰 UI 업데이트할 값들', { 월수입, 월지출, 투자여력, 수입건수, 지출건수 });
                
                // 월 수입 업데이트
                document.getElementById('monthlyIncomeValue').textContent = 
                    `+${숫자포맷(월수입)}만원`;
                document.getElementById('monthlyIncomeDetail').textContent = 
                    `수입 ${수입건수}건`;
                
                // 월 지출 업데이트
                document.getElementById('monthlyExpenseValue').textContent = 
                    `-${숫자포맷(월지출)}만원`;
                document.getElementById('monthlyExpenseDetail').textContent = 
                    `지출 ${지출건수}건`;
                
                // 투자여력 업데이트
                const 투자여력색상 = 투자여력 >= 0 ? '#28a745' : '#dc3545';
                const 투자여력요소 = document.getElementById('investmentCapacityValue');
                투자여력요소.textContent = `${숫자포맷(투자여력)}만원`;
                투자여력요소.style.color = 투자여력색상;
                
                document.getElementById('investmentCapacityDetail').textContent = 
                    투자여력 >= 0 ? '흑자' : '적자';
                
                업데이트시간갱신();
                상태메시지표시('수입/지출 데이터가 업데이트되었습니다', 'success');
                로그('✅ 모듈2 UI 업데이트 완료');
                
            } catch (error) {
                로그('❌ 모듈2 UI 업데이트 오류', error);
                console.error('모듈2 UI 업데이트 오류 상세:', error);
            }
        }
        
        /*
        ===========================================
        ⭐ 개선된 UI 제어 함수들 ⭐
        ===========================================
        */
        
        // 모듈 전환
        function 모듈전환(모듈이름) {
            로그(`🔄 모듈 전환: ${모듈이름}`);
            
            // 탭 활성화 상태 변경
            document.querySelectorAll('.module-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 모듈 프레임 전환
            document.querySelectorAll('.module-frame').forEach(frame => {
                frame.classList.remove('active');
            });
            document.getElementById(모듈이름).classList.add('active');
            
            현재모듈 = 모듈이름;
            
            // 모듈 전환 시 강제 데이터 읽기
            setTimeout(() => {
                if (모듈이름 === 'module1') {
                    모듈1데이터읽기();
                } else if (모듈이름 === 'module2') {
                    모듈2데이터읽기();
                }
            }, 100);
        }
        
        // ⭐ 강화된 전체 데이터 새로고침
        function 전체데이터새로고침() {
            로그('🔄 강화된 전체 데이터 새로고침 시작');
            상태메시지표시('데이터를 새로고침하는 중...', 'info');
            
            // 1단계: localStorage에서 직접 읽기
            const 모듈1성공 = 모듈1데이터읽기();
            const 모듈2성공 = 모듈2데이터읽기();
            
            // 2단계: 모듈들에게 새로고침 요청
            try {
                const module1Frame = document.getElementById('module1');
                const module2Frame = document.getElementById('module2');
                
                if (module1Frame && module1Frame.contentWindow) {
                    module1Frame.contentWindow.postMessage({
                        type: 'REFRESH_REQUEST'
                    }, '*');
                }
                
                if (module2Frame && module2Frame.contentWindow) {
                    module2Frame.contentWindow.postMessage({
                        type: 'REFRESH_REQUEST'
                    }, '*');
                }
            } catch (error) {
                로그('⚠️ iframe 새로고침 신호 전송 실패', error);
            }
            
            // 3단계: 모듈들에게 데이터 요청
            setTimeout(() => {
                모든모듈데이터요청();
            }, 1000);
            
            // 4단계: 결과 표시
            setTimeout(() => {
                if (모듈1연결상태 || 모듈2연결상태) {
                    상태메시지표시('데이터를 새로고침했습니다.', 'success');
                    로그('✅ 새로고침 완료');
                } else {
                    상태메시지표시('저장된 데이터가 없습니다. 모듈에서 데이터를 먼저 저장해주세요.', 'info');
                    로그('⚠️ 새로고침할 데이터 없음');
                }
            }, 2000);
        }
        
        // 업데이트 시간 갱신
        function 업데이트시간갱신() {
            const 지금 = new Date();
            const 시간문자열 = 지금.toLocaleString();
            document.getElementById('lastUpdateTime').textContent = 시간문자열;
        }
        
        // 상태 메시지 표시
        function 상태메시지표시(메시지, 타입 = 'success') {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = 메시지;
            statusMessage.className = 'status-message show';
            
            if (타입 === 'error') {
                statusMessage.classList.add('error');
            } else if (타입 === 'info') {
                statusMessage.classList.add('info');
            }
            
            setTimeout(() => {
                statusMessage.classList.remove('show');
            }, 3000);
            
            로그(`📢 상태메시지: ${메시지} (${타입})`);
        }
        
        /*
        ===========================================
        ⭐ 강화된 초기화 함수 ⭐
        ===========================================
        */
        
        function 대시보드초기화() {
            로그('🚀 통합 대시보드 초기화 시작');
            
            // 1단계: 즉시 localStorage 데이터 읽기
            setTimeout(() => {
                로그('📂 localStorage에서 데이터 읽기 시작');
                
                const 모듈1성공 = 모듈1데이터읽기();
                const 모듈2성공 = 모듈2데이터읽기();
                
                로그(`📂 초기 데이터 읽기 결과: 모듈1(${모듈1성공}), 모듈2(${모듈2성공})`);
                
                // 로딩 화면 숨기기
                document.getElementById('loadingState').classList.remove('active');
                
                if (!모듈1성공 && !모듈2성공) {
                    상태메시지표시('저장된 데이터가 없습니다. 각 모듈에서 데이터를 추가해주세요.', 'info');
                } else {
                    상태메시지표시('대시보드가 성공적으로 로드되었습니다.', 'success');
                }
                
                // 저장소 변경 감지 시작
                저장소변경감지시작();
                
            }, 500);
            
            // 2단계: iframe 로드 이벤트 처리
            const module1Frame = document.getElementById('module1');
            const module2Frame = document.getElementById('module2');
            
            // 모듈1 로드 이벤트
            module1Frame.addEventListener('load', function() {
                로그('🖼️ 모듈1 iframe 로드 완료');
                
                // 여러 번 시도하여 안정적인 연결 확보
                const 연결시도 = (시도횟수) => {
                    if (시도횟수 > 0) {
                        모듈1데이터읽기();
                        setTimeout(() => 연결시도(시도횟수 - 1), 1000);
                    }
                };
                연결시도(5); // 5번 시도
            });
            
            // ⭐ 모듈2 로드 이벤트 (강화)
            module2Frame.addEventListener('load', function() {
                로그('🖼️ 모듈2 iframe 로드 완료');
                
                // 여러 번 시도하여 안정적인 연결 확보
                const 연결시도 = (시도횟수) => {
                    if (시도횟수 > 0) {
                        로그(`🔄 모듈2 연결 시도 ${6-시도횟수}/5`);
                        모듈2데이터읽기();
                        setTimeout(() => 연결시도(시도횟수 - 1), 1000);
                    }
                };
                연결시도(5); // 5번 시도
            });
            
            // 3단계: 초기 시간 설정
            업데이트시간갱신();
            동기화상태업데이트();
            
            // 4단계: 주기적 데이터 갱신 (30초마다) + 모듈 데이터 요청 (15초마다)
            setInterval(() => {
                if (!디버그모드) return; // 디버그 모드일 때만 주기적 갱신
                
                로그('⏰ 주기적 동기화 실행');
                모듈1데이터읽기();
                모듈2데이터읽기();
            }, 30 * 1000);
            
            // 5단계: 정기적으로 모듈들에게 데이터 요청 (15초마다)
            setInterval(() => {
                if (디버그모드) {
                    로그('⏰ 정기적 데이터 요청 실행');
                    모든모듈데이터요청();
                }
            }, 15000);
            
            // 6단계: 초기 데이터 요청 (3초 후)
            setTimeout(() => {
                로그('🚀 초기 데이터 요청 실행');
                모든모듈데이터요청();
            }, 3000);
            
            // ⭐ 7단계: 추가 모듈2 특별 처리 (10초 후)
            setTimeout(() => {
                로그('🚀 모듈2 추가 데이터 요청 실행');
                모듈2데이터요청();
                모듈2데이터읽기();
            }, 10000);
            
            로그('✅ 대시보드 초기화 완료');
            console.log('🎉 완전한 PostMessage 수신 로직이 활성화되었습니다!');
            console.log('🔧 디버그 모드는 우하단 설정 버튼으로 활성화할 수 있습니다.');
        }
        
        // DOM 로드 완료 시 초기화
        document.addEventListener('DOMContentLoaded', 대시보드초기화);
        
        // 페이지 포커스 시 데이터 갱신
        window.addEventListener('focus', function() {
            로그('👁️ 페이지 포커스 - 자동 동기화 실행');
            
            setTimeout(() => {
                모듈1데이터읽기();
                모듈2데이터읽기();
                // 추가: 모듈들에게도 데이터 요청
                모든모듈데이터요청();
            }, 300);
        });
        
        // 페이지 가시성 변경 시 처리
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                로그('👁️ 페이지 다시 보임 - 데이터 갱신');
                setTimeout(() => {
                    모듈1데이터읽기();
                    모듈2데이터읽기();
                    // 추가: 모듈들에게도 데이터 요청
                    모든모듈데이터요청();
                }, 300);
            }
        });
        
        // 페이지 언로드 시 정리
        window.addEventListener('beforeunload', function() {
            if (저장소감지타이머) {
                clearInterval(저장소감지타이머);
            }
        });
    </script>
</body>
</html>